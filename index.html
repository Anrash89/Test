<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–®–∫–æ–ª–∞ –§–æ–∫—É—Å–æ–≤ –†–æ–º–∞–Ω–∞ Magic üÉè | –†—É–ª–µ—Ç–∫–∞ –ø—Ä–∏–∑–æ–≤</title>
  <link href="https://fonts.googleapis.com/css2?family=Bungee+Inline&family=Rubik+Marker+Hatch&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --primary:#f39c12; --secondary:#3498db; --accent:#e74c3c;
      --card-shadow:0 10px 25px rgba(0,0,0,.25);
      --bg:#fafbff;
      --text:#222;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:'Nunito',system-ui,Segoe UI,Arial;
      color:var(--text);
      background:radial-gradient(1200px 600px at 50% -10%, #fff 0%, #eef3ff 40%, #e9edf7 70%, #dde3f7 100%);
      min-height:100vh; display:flex; flex-direction:column;
    }
    header{background:var(--primary);color:#fff;text-align:center;padding:16px 10px;box-shadow:0 4px 18px rgba(0,0,0,.2)}
    header h1{font-family:'Bungee Inline',cursive;letter-spacing:.5px;text-shadow:2px 2px 0 #c0392b}
    main{width:100%;max-width:980px;margin:0 auto;padding:18px}

    /* ===== ROULETTE CARD ===== */
    .roulette-card{
      display:grid;grid-template-columns:1fr;gap:18px;align-items:center;
      background:#fff;border-radius:18px;box-shadow:var(--card-shadow);padding:18px
    }
    @media(min-width:900px){ .roulette-card{ grid-template-columns:520px 1fr; padding:24px }}
    .wheel-wrap{position:relative;display:flex;justify-content:center;align-items:center;padding:6px}
    .wheel{
      width:480px; height:480px; max-width:100%;
      border-radius:50%; background:#10131a; position:relative;
      box-shadow:inset 0 0 0 10px #1f2433, inset 0 0 0 14px #0b0e15, 0 20px 50px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .pointer{
      position:absolute; top:-8px; left:50%; transform:translateX(-50%);
      width:0;height:0;border-left:18px solid transparent;border-right:18px solid transparent;border-bottom:28px solid #fff;
      filter:drop-shadow(0 6px 8px rgba(0,0,0,.35)); z-index:5;
    }
    canvas{display:block;width:100%;height:100%}
    .controls{display:grid;gap:12px}
    .controls h2{font-family:'Rubik Marker Hatch',cursive;color:var(--secondary);font-size:1.8rem}
    .btn{
      background:linear-gradient(180deg,#ffd06a 0%, #f39c12 60%, #e08400 100%);
      color:#111;border:none;border-radius:12px;padding:14px 18px;font-weight:900;
      cursor:pointer;box-shadow:0 8px 18px rgba(243,156,18,.45); transition:.15s; font-size:1.07rem;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn:disabled{opacity:.55;cursor:not-allowed;filter:grayscale(.2)}
    .btn-secondary{
      background:linear-gradient(180deg,#72b8ff 0%, #3498db 60%, #1d6fa5 100%);
      color:#fff;box-shadow:0 8px 18px rgba(52,152,219,.45)
    }
    .note{font-size:.95rem;line-height:1.45;background:#f8fbff;border:1px dashed #d6e6ff;padding:10px 12px;border-radius:10px}
    .stats{display:flex;gap:12px;flex-wrap:wrap}
    .pill{background:#111;color:#fff;border-radius:999px;padding:8px 12px;font-weight:800;font-size:.95rem}
    .pill.sub{background:#1abc9c}
    .pill.spins{background:#8e44ad}
    .prob{font-size:.9rem;color:#5c667a}
    .prize-badges{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .badge{padding:6px 10px;border-radius:999px;background:#f0f3ff;border:1px solid #dfe6ff;font-weight:700;font-size:.88rem}
    .badge.red{background:#ffe9e9;border-color:#ffd0d0;color:#b10000}
    .vip-card{
      margin-top:16px;background:#0f1220;color:#fff;border-radius:14px;padding:14px 16px;box-shadow:inset 0 0 80px rgba(255,255,255,.05);
    }
    .vip-card h3{margin-bottom:8px;font-size:1.1rem}
    .vip-card ul{margin-left:18px;margin-top:6px}
    .vip-card li{margin:4px 0}
    .hidden{display:none !important}
  </style>
</head>
<body>
<header><h1>–®–∫–æ–ª–∞ –§–æ–∫—É—Å–æ–≤ –†–æ–º–∞–Ω–∞ Magic üÉè</h1></header>
<main>

  <!-- ======= –ë–ª–æ–∫ ¬´–†—É–ª–µ—Ç–∫–∞¬ª ======= -->
  <section id="roulette" class="roulette-card">
    <div class="wheel-wrap">
      <div class="pointer"></div>
      <div class="wheel"><canvas id="wheelCanvas" width="1000" height="1000"></canvas></div>
    </div>

    <div class="controls">
      <h2>üé∞ –¢–∞–π–Ω–∏–∫ ‚Äî VIP-—Ä—É–ª–µ—Ç–∫–∞</h2>

      <div class="stats">
        <span id="pill-sub" class="pill sub hidden">–ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞: 2 –∫—Ä—É—Ç–∫–∏/–¥–µ–Ω—å</span>
        <span id="pill-spins" class="pill spins">–î–æ—Å—Ç—É–ø–Ω–æ –∫—Ä—É—Ç–æ–∫: <b id="spinsLeft">0</b></span>
      </div>

      <button id="spinBtn" class="btn">–ö—Ä—É—Ç–∏—Ç—å —Ä—É–ª–µ—Ç–∫—É</button>
      <button id="subscribeBtn" class="btn btn-secondary">–û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É ‚Äî 299 ‚ÇΩ/–º–µ—Å</button>

      <div class="note">
        –†—É–ª–µ—Ç–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ <b>—Ç–æ–ª—å–∫–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º –∏–∑ Telegram</b> (–≤–∫–ª—é—á–∞–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –∫—Ä—É—Ç–∫–∏).  
        <br/>–ë–æ–Ω—É—Å: –ø—Ä–∏–≥–ª–∞—Å–∏ –¥—Ä—É–≥–∞ –≤ –±–æ—Ç–∞ –ø–æ —Å–≤–æ–µ–π —Å—Å—ã–ª–∫–µ ‚Äî –ø–æ–ª—É—á–∏ <b>+1 –∫—Ä—É—Ç–∫—É</b>, –∫–æ–≥–¥–∞ –æ–Ω —Å–¥–µ–ª–∞–µ—Ç —Å–≤–æ—é –ø–µ—Ä–≤—É—é –ø—Ä–æ–∫—Ä—É—Ç–∫—É.
      </div>

      <div class="prob">
        –®–∞–Ω—Å—ã: 
        <div class="prize-badges">
          <span class="badge">üéÅ ‚Äì5% (25%)</span>
          <span class="badge">üéÅ ‚Äì15% (10%)</span>
          <span class="badge">üéÅ ‚Äì25% (5%)</span>
          <span class="badge">üéß –ù–∞—É—à–Ω–∏–∫–∏ (1%)</span>
          <span class="badge">üîä JBL (1%)</span>
          <span class="badge red">üéÆ PlayStation (0.01%)</span>
          <span class="badge red">üì± iPhone (0.01%)</span>
          <span class="badge">‚àÖ –ü—É—Å—Ç–æ (57.98%)</span>
        </div>
      </div>

      <div class="vip-card">
        <h3>üîí –ó–∞–∫—Ä—ã—Ç—ã–π –∫–∞–Ω–∞–ª ¬´–¢–∞–π–Ω–∏–∫¬ª ‚Äî —á—Ç–æ –≤–Ω—É—Ç—Ä–∏?</h3>
        <ul>
          <li>–°–µ–∫—Ä–µ—Ç—ã —Ñ–æ–∫—É—Å–æ–≤ –∏ –∫—Ä–∞—Ç–∫–∏–µ –æ–±—É—á–∞–ª–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –≤—ã–∫–ª–∞–¥—ã–≤–∞—é—Ç—Å—è –ø—É–±–ª–∏—á–Ω–æ.</li>
          <li>–õ–∏—á–Ω–æ–µ –æ–±—â–µ–Ω–∏–µ —Å–æ –º–Ω–æ–π: –æ—Ç–≤–µ—á–∞—é –Ω–∞ –≤–∏–¥–µ–æ –≤–∞—à–∏—Ö —Ç—Ä—é–∫–æ–≤, –¥–∞—é —Å–æ–≤–µ—Ç—ã.</li>
          <li>–ß–µ–ª–ª–µ–Ω–¥–∂–∏ –∏ –º–∏–Ω–∏-–∑–∞–¥–∞–Ω–∏—è ‚Äî –≤—ã–∫–ª–∞–¥—ã–≤–∞–π—Ç–µ –≤–∏–¥–æ—Å—ã, –ø–æ–ª—É—á–∞–π—Ç–µ —Ä–∞–∑–±–æ—Ä.</li>
          <li>–ï–∂–µ–º–µ—Å—è—á–Ω—ã–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∏ –ø—Ä–∏–∑–æ–≤ –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.</li>
        </ul>
      </div>

      <div id="resultBox" class="note hidden"></div>
    </div>
  </section>

  <!-- –ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –≤–∞—à–∏ —Å–µ–∫—Ü–∏–∏ —É—Ä–æ–∫–æ–≤ –Ω–∏–∂–µ -->
</main>

<script>
/* ========================== –ù–ê–°–¢–†–û–ô–ö–ò ========================== */
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycby2R4j1aBQ2zmybXyqjVhgFntoduCYYX6AuZ8kMmRUWdF8ZQCNTTpPij0kmxaSxAZmjvg/exec';
// Prodamus: —Å–æ–∑–¥–∞–π—Ç–µ —Ç–æ–≤–∞—Ä ¬´–ü–æ–¥–ø–∏—Å–∫–∞ –¢–∞–π–Ω–∏–∫ 299 ‚ÇΩ/–º–µ—Å¬ª ‚Üí –°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ–ø–ª–∞—Ç—ã ‚Üí —É–∫–∞–∂–∏—Ç–µ redirect URL –≤–∏–¥–∞:
// https://–í–ê–®_–°–ê–ô–¢/?sub=1&tg_id={telegram_user_id}
// –í—Ä–µ–º–µ–Ω–Ω–æ –ø–æ—Å—Ç–∞–≤–∏–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä:
const PRODAMUS_PAY_URL_BASE = 'https://pay.your-prodamus.example/subscribe-299'; // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à—É —Å—Å—ã–ª–∫—É

/* ======================= –¢–ï–õ–ï–ì–†–ê–ú / –ö–û–ù–¢–ï–ö–°–¢ ==================== */
function getTelegramId(){
  if (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user){
    return String(Telegram.WebApp.initDataUnsafe.user.id);
  }
  const url = new URL(location.href);
  const tg = url.searchParams.get('tg_id');
  const ls = localStorage.getItem('magic_tg_id');
  if (tg){ localStorage.setItem('magic_tg_id', tg); return tg; }
  return ls || null;
}
/* –†–µ—Ñ–µ—Ä–∞–ª: –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∏–µ –ø–æ ?ref=123, –∑–∞–ø–æ–º–Ω–∏–º, –∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–µ –æ—Ç–ø—Ä–∞–≤–∏–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä */
function getReferrerFromUrl(){
  const url = new URL(location.href);
  const ref = url.searchParams.get('ref');
  if (ref){ localStorage.setItem('magic_referrer', ref); }
  return localStorage.getItem('magic_referrer');
}

/* ========================= –ü–û–î–ü–ò–°–ö–ê ============================ */
function hasActiveSubscription(){
  return localStorage.getItem('magic_sub_active') === '1';
}
function setSubscriptionActive(active){
  localStorage.setItem('magic_sub_active', active ? '1':'0');
  document.getElementById('pill-sub').classList.toggle('hidden', !active);
}

/* –ï—Å–ª–∏ after-pay —Ä–µ–¥–∏—Ä–µ–∫—Ç */
(function handlePostPay(){
  const url = new URL(location.href);
  if (url.searchParams.get('sub') === '1'){ setSubscriptionActive(true); }
})();

/* ========================= –õ–ò–ú–ò–¢–´ –ö–†–£–¢–û–ö ======================= */
function todayKey(){ const d=new Date(); return d.getFullYear()+'-'+(d.getMonth()+1)+'-'+d.getDate(); }
function getDailyLimit(){ return hasActiveSubscription()?2:1; }
function loadSpinState(){
  const key = todayKey();
  const data = JSON.parse(localStorage.getItem('magic_spin_state')||'{}');
  if (data.date !== key){ return {date:key, used:0, bonus: Number(localStorage.getItem('magic_bonus_pool')||'0')}; }
  return data;
}
function saveSpinState(st){
  localStorage.setItem('magic_spin_state', JSON.stringify(st));
  localStorage.setItem('magic_bonus_pool', String(st.bonus||0));
  updateSpinsUI();
}
function addBonusSpin(n=1){
  const st = loadSpinState(); st.bonus = (st.bonus||0)+n; saveSpinState(st);
}

/* –°–∫–æ–ª—å–∫–æ –æ—Å—Ç–∞–ª–æ—Å—å */
function spinsLeft(){
  const st=loadSpinState();
  return Math.max(0, getDailyLimit() - st.used) + (st.bonus||0);
}
function consumeSpin(){
  const st=loadSpinState();
  if (st.bonus>0){ st.bonus--; }
  else { st.used = Math.min(getDailyLimit(), st.used+1); }
  saveSpinState(st);
}
function updateSpinsUI(){
  document.getElementById('spinsLeft').textContent = spinsLeft();
  document.getElementById('spinBtn').disabled = (spinsLeft()<=0);
}

/* ========================= –ü–†–û–î–ê–ú–£–° –ö–ù–û–ü–ö–ê ===================== */
document.getElementById('subscribeBtn').addEventListener('click', ()=>{
  const tg = getTelegramId();
  const url = new URL(PRODAMUS_PAY_URL_BASE);
  if (tg){ url.searchParams.set('tg_id', tg); }
  // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: url.searchParams.set('redirect', location.origin + location.pathname + '?sub=1&tg_id='+tg);
  window.open(url.toString(), '_blank');
});

/* ========================= –ü–†–ò–ó–´ –ò –í–ï–°–ê ======================== */
/* –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ (–≤ %) —Å—É–º–º–∞—Ä–Ω–æ = 100 */
const prizes = [
  {key:'empty',     label:'–ü–æ–≤–µ–∑—ë—Ç –≤ –¥—Ä—É–≥–æ–π —Ä–∞–∑', emoji:'‚àÖ',    weight:57.98, color:'#2e3447'},
  {key:'off5',      label:'–°–∫–∏–¥–∫–∞ 5% –Ω–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ',  emoji:'‚Äì5%',  weight:25,    color:'#1f7aec'},
  {key:'off15',     label:'–°–∫–∏–¥–∫–∞ 15% –Ω–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ', emoji:'‚Äì15%', weight:10,    color:'#3dbdff'},
  {key:'off25',     label:'–°–∫–∏–¥–∫–∞ 25% –Ω–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ', emoji:'‚Äì25%', weight:5,     color:'#59dfa6'},
  {key:'headphones',label:'–ù–∞—É—à–Ω–∏–∫–∏',                 emoji:'üéß',   weight:1,     color:'#9b59b6'},
  {key:'jbl',       label:'–ö–æ–ª–æ–Ω–∫–∞ JBL',              emoji:'üîä',   weight:1,     color:'#e67e22'},
  {key:'ps',        label:'PlayStation',              emoji:'üéÆ',   weight:0.01,  color:'#e74c3c'},
  {key:'iphone',    label:'iPhone',                   emoji:'üì±',   weight:0.01,  color:'#c0392b'}
];

/* ========================= –†–ò–°–£–ï–ú –ö–û–õ–ï–°–û ======================= */
const canvas = document.getElementById('wheelCanvas');
const ctx = canvas.getContext('2d');
const CENTER = canvas.width/2;
function drawWheel(rotation=0){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const total = prizes.length;
  const slice = 2*Math.PI/total;
  ctx.save();
  ctx.translate(CENTER,CENTER);
  ctx.rotate(rotation);
  for(let i=0;i<total;i++){
    // —Å–µ–∫—Ç–æ—Ä
    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.arc(0,0,CENTER-18,i*slice,(i+1)*slice);
    ctx.closePath();
    ctx.fillStyle = prizes[i].color;
    ctx.fill();
    // —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
    ctx.strokeStyle='rgba(255,255,255,.15)'; ctx.lineWidth=6; ctx.stroke();

    // —Ç–µ–∫—Å—Ç
    ctx.save();
    ctx.rotate(i*slice + slice/2);
    ctx.textAlign='center';
    ctx.fillStyle='#fff';
    ctx.font='bold 42px Nunito';
    ctx.fillText(prizes[i].emoji, CENTER*0.63, 16);
    ctx.font='600 26px Nunito';
    wrapText(prizes[i].label, CENTER*0.63, 60, 280, 26);
    ctx.restore();
  }
  ctx.restore();
}
function wrapText(text, x, y, maxWidth, lineHeight){
  const words=text.split(' '); let line=''; let yy=y;
  for(let n=0;n<words.length;n++){
    const test=line+words[n]+' ';
    if (ctx.measureText(test).width>maxWidth && n>0){
      ctx.fillText(line, x, yy); line=words[n]+' '; yy+=lineHeight;
    }else line=test;
  }
  ctx.fillText(line, x, yy);
}
drawWheel();

/* ==================== –í–´–ë–û–† –ü–û –í–ï–°–ê–ú + –ê–ù–ò–ú–ê–¶–ò–Ø ================ */
function pickPrize(){
  const r = Math.random()*100; let acc=0;
  for (const p of prizes){
    acc += p.weight;
    if (r <= acc) return p;
  }
  return prizes[0]; // fallback
}
/* –î–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–æ–ø–∞–¥—ë–º –Ω–∞ –Ω—É–∂–Ω—ã–π —Å–µ–∫—Ç–æ—Ä */
function angleForPrize(prizeIndex){
  const total = prizes.length;
  const slice = 2*Math.PI/total;
  // –£–∫–∞–∑–∞—Ç–µ–ª—å —Å–≤–µ—Ä—Ö—É (0 —Ä–∞–¥). –ö–æ–ª–µ—Å–æ –∫—Ä—É—Ç–∏—Ç—Å—è, –∑–Ω–∞—á–∏—Ç —Ü–µ–ª–∏–º—Å—è —Ç–∞–∫, —á—Ç–æ–±—ã —Å–µ–∫—Ç–æ—Ä prizeIndex –æ–∫–∞–∑–∞–ª—Å—è –ø–æ–¥ —É–∫–∞–∑–∞—Ç–µ–ª–µ–º.
  const targetAngle = (Math.PI*1.5) - (prizeIndex*slice + slice/2);
  return targetAngle;
}

let spinning=false, currentRotation=0;
function spin(){
  if (spinning) return;
  if (spinsLeft()<=0){ showResult('–ö—Ä—É—Ç–æ–∫ –Ω–µ—Ç. –ü—Ä–∏–≥–ª–∞—Å–∏ –¥—Ä—É–≥–∞ –∏–ª–∏ –æ—Ñ–æ—Ä–º–∏ –ø–æ–¥–ø–∏—Å–∫—É.', true); return; }

  spinning=true;
  const prize = pickPrize();
  const idx = prizes.findIndex(p=>p.key===prize.key);

  // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±–æ—Ä–æ—Ç–æ–≤ + –ø–æ–ø–∞–¥–∞–Ω–∏–µ
  const extraTurns = 6 + Math.floor(Math.random()*3); // 6‚Äì8 –æ–±–æ—Ä–æ—Ç–æ–≤
  const target = angleForPrize(idx) + extraTurns*2*Math.PI;

  const duration = 4500; // –º—Å
  const start = performance.now();
  const startRot = currentRotation;

  const easeOutCubic = t => 1 - Math.pow(1 - t, 3);

  function frame(now){
    const t = Math.min(1, (now - start)/duration);
    const eased = easeOutCubic(t);
    const rot = startRot + (target - startRot)*eased;
    currentRotation = rot;
    drawWheel(currentRotation);
    if (t<1){ requestAnimationFrame(frame); }
    else{
      spinning=false;
      onSpinFinished(prize);
    }
  }
  requestAnimationFrame(frame);
}

/* ========================= –ò–¢–û–ì –°–ü–ò–ù–ê ========================== */
const spinBtn = document.getElementById('spinBtn');
spinBtn.addEventListener('click', ()=>{
  // –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ —Å tg_id
  const tg = getTelegramId();
  if (!tg){ showResult('–†—É–ª–µ—Ç–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ Telegram. –û—Ç–∫—Ä–æ–π—Ç–µ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±–æ—Ç–∞.', true); return; }
  spin();
});

function showResult(text, warn=false){
  const box = document.getElementById('resultBox');
  box.textContent = text;
  box.classList.toggle('hidden', false);
  box.style.borderColor = warn ? '#ffb3b3' : '#d6e6ff';
  box.style.background = warn ? '#fff1f1' : '#f8fbff';
}

async function onSpinFinished(prize){
  consumeSpin();
  const tg = getTelegramId();
  const referrer = localStorage.getItem('magic_referrer'); // –µ—Å–ª–∏ —ç—Ç–æ—Ç —é–∑–µ—Ä –ø—Ä–∏—à—ë–ª –ø–æ —Ä–µ—Ñ–∫–µ
  updateSpinsUI();

  // –°–æ–æ–±—â–µ–Ω–∏–µ
  const label = (prize.key==='empty') ? '–°–µ–≥–æ–¥–Ω—è –±–µ–∑ –ø—Ä–∏–∑–∞ ‚Äî –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–≤—Ç—Ä–∞!' :
    `–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏: ${prize.emoji} ${prize.label}`;
  showResult(label);

  // –û—Ç–ø—Ä–∞–≤–∏–º –Ω–∞ Apps Script: —Ñ–∏–∫—Å–∞—Ü–∏—è —Å–ø–∏–Ω–∞
  const payload = {
    action:'spin',
    tg_id: tg || 'unknown',
    prize_key: prize.key,
    prize_label: prize.label,
    ts: new Date().toISOString(),
    referrer: referrer || null
  };
  fetch(WEB_APP_URL, {
    method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  }).catch(()=>{});

  /* –õ–æ–≥–∏–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–∫–∏ (–∫—Ä–µ–¥–∏—Ç–∏–º –ø—Ä–∏–≥–ª–∞—Å–∏–≤—à–µ–º—É +1 –∫—Ä—É—Ç–∫—É)
     –†–µ–∞–ª—å–Ω–æ –ª—É—á—à–µ –¥–µ–ª–∞—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ: –∫–æ–≥–¥–∞ —ç—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–¥–µ–ª–∞–ª —Å–≤–æ–π –ü–ï–†–í–´–ô —Å–ø–∏–Ω,
     —Å–µ—Ä–≤–µ—Ä –Ω–∞—Ö–æ–¥–∏—Ç referrer –∏ –Ω–∞—á–∏—Å–ª—è–µ—Ç –µ–º—É –±–æ–Ω—É—Å.
     –í—Ä–µ–º–µ–Ω–Ω—ã–π –ª–æ–∫–∞–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç (–¥–ª—è —Ç–µ—Å—Ç–∞): –µ—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è ‚Äî –ø–∏–Ω–≥—É–µ–º —Å–µ—Ä–≤–µ—Ä —ç–∫—à–µ–Ω–æ–º credit_ref.
  */
  if (!localStorage.getItem('magic_first_spin_done')){
    localStorage.setItem('magic_first_spin_done','1');
    if (referrer){
      fetch(WEB_APP_URL, {
        method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({action:'credit_ref', referrer, by: tg || 'unknown', ts:new Date().toISOString()})
      }).catch(()=>{});
    }
  }
}

/* ========================= –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ======================= */
(function init(){
  // —Å–æ—Ö—Ä–∞–Ω–∏–º tg
  const tg = getTelegramId(); if (tg) localStorage.setItem('magic_tg_id', tg);
  getReferrerFromUrl();

  // –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã–ª–∏ —Å–∞–π—Ç –±–µ–∑ tg_id ‚Äî —Å–ø—Ä—è—á–µ–º –∫–Ω–æ–ø–∫–∏, –Ω–æ –æ—Å—Ç–∞–≤–∏–º –æ–ø–∏—Å–∞–Ω–∏–µ
  if (!tg){
    document.getElementById('spinBtn').disabled = true;
    showResult('–†—É–ª–µ—Ç–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∏–∑ Telegram-–±–æ—Ç–∞. –û—Ç–∫—Ä–æ–π—Ç–µ —Å–∞–π—Ç —á–µ—Ä–µ–∑ –±–æ—Ç–∞.', true);
  }

  // –ø–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏
  setSubscriptionActive(hasActiveSubscription());

  // –µ—Å–ª–∏ —É Prodamus –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –≤—ã –¥–µ–ª–∞–µ—Ç–µ redirect —Å ?sub=1 ‚Äî –º—ã —É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª–∏ –≤—ã—à–µ
  updateSpinsUI();
})();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–®–∫–æ–ª–∞ –§–æ–∫—É—Å–æ–≤ –†–æ–º–∞–Ω–∞ Magic üÉè | –†—É–ª–µ—Ç–∫–∞ –ø—Ä–∏–∑–æ–≤</title>
  <link href="https://fonts.googleapis.com/css2?family=Bungee+Inline&family=Rubik+Marker+Hatch&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --primary:#f39c12; --secondary:#3498db; --accent:#e74c3c;
      --bg:#0b0f18; --panel:#111827; --card:#0f1422; --muted:#9aa5b1;
      --green:#15d198; --ring:#2b3143; --ring2:#1a2032;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Nunito',system-ui,Segoe UI,Arial;background:radial-gradient(1200px 600px at 50% -10%, #0f162a 0%, #0b0f18 60%);color:#e9eef7;min-height:100vh;display:flex;flex-direction:column}
    header{background:linear-gradient(180deg,#151c2f,#0f1422);border-bottom:1px solid #1e2336;box-shadow:0 10px 30px rgba(0,0,0,.4);padding:16px 10px;text-align:center}
    header h1{font-family:'Bungee Inline',cursive;color:#fff;text-shadow:0 2px 0 #000}

    main{width:100%;max-width:1080px;margin:0 auto;padding:20px}

    /* ====== STRIP ROULETTE ====== */
    .roulette-card{
      background:linear-gradient(180deg,var(--panel),#0b1020);
      border:1px solid #1f2540;border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,.5);
      padding:18px;display:grid;gap:18px
    }
    @media(min-width:900px){ .roulette-card{grid-template-columns:1fr 380px}}

    .strip-wrap{
      position:relative;overflow:hidden;border-radius:14px;
      background:linear-gradient(180deg,#0c1222,#0a0f1d);
      box-shadow:inset 0 0 0 2px var(--ring),inset 0 0 0 10px var(--ring2);
      padding:18px;
    }
    .strip{
      display:flex;gap:14px;will-change:transform;transform:translate3d(0,0,0);
      filter:blur(0px); /* –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –º–µ–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–º —Å—Ç–∞—Ä—Ç–µ */
    }
    .item{
      flex:0 0 240px;height:140px;
      background:linear-gradient(180deg,#0f1424,#0b0f1b); border:1px solid #2a324b;
      border-radius:14px; position:relative; color:#cdd6e6;
      display:flex; align-items:flex-end; padding:12px; overflow:hidden;
      box-shadow:0 10px 18px rgba(0,0,0,.35), inset 0 0 40px rgba(255,255,255,.03);
    }
    .item:before{
      content:""; position:absolute; inset:0; background:radial-gradient(180px 90px at 70% 25%, rgba(255,255,255,.08), transparent 60%);
      pointer-events:none;
    }
    .item .icon{
      position:absolute; top:16px; left:16px; font-size:30px; opacity:.95
    }
    .item .title{font-weight:800;font-size:14px}
    .item .tag{position:absolute; right:12px; bottom:10px; font-size:12px; color:var(--muted)}
    .item.highlight{outline:2px solid #26d3a6; box-shadow:0 0 0 3px rgba(38,211,166,.15),0 10px 18px rgba(0,0,0,.35)}

    /* –¶–µ–Ω—Ç—Ä-—É–∫–∞–∑–∞—Ç–µ–ª—å (—Å—Ç—Ä–µ–ª–∫–∏ —Å–≤–µ—Ä—Ö—É/—Å–Ω–∏–∑—É) */
    .pointerTop,.pointerBottom{
      position:absolute; left:50%; transform:translateX(-50%); width:0;height:0; z-index:10;
      filter:drop-shadow(0 6px 10px rgba(0,0,0,.55));
    }
    .pointerTop{ top:6px; border-left:12px solid transparent;border-right:12px solid transparent;border-bottom:18px solid #fff; }
    .pointerBottom{ bottom:6px; border-left:12px solid transparent;border-right:12px solid transparent;border-top:18px solid #fff; }

    .controls{display:grid;gap:12px}
    .controls h2{font-family:'Rubik Marker Hatch',cursive;color:#7bc3ff}
    .btn{
      border:none;border-radius:12px;padding:14px 18px;font-weight:900;cursor:pointer;font-size:1.02rem;
      background:linear-gradient(180deg,#ffd06a,#f39c12 60%,#e08400);color:#111;
      box-shadow:0 10px 20px rgba(243,156,18,.4);transition:.15s
    }
    .btn:hover{transform:translateY(-1px)}
    .btn:disabled{opacity:.55;cursor:not-allowed;filter:grayscale(.2)}
    .btn-secondary{background:linear-gradient(180deg,#72b8ff,#3498db 60%,#1d6fa5);color:#fff;box-shadow:0 10px 20px rgba(52,152,219,.4)}
    .stats{display:flex;gap:10px;flex-wrap:wrap}
    .pill{background:#182036;border:1px solid #2b3557;border-radius:999px;padding:8px 12px;font-weight:800;font-size:.95rem;color:#cfe6ff}
    .pill.sub{background:#102a27;border-color:#1d5b50;color:#8ff5d7}
    .note{font-size:.95rem;line-height:1.45;background:#0e1529;border:1px dashed #2b3a67;padding:10px 12px;border-radius:10px;color:#c6d1f3}
    .result{font-weight:800}
    .hidden{display:none !important}
  </style>
</head>
<body>
<header><h1>–®–∫–æ–ª–∞ –§–æ–∫—É—Å–æ–≤ –†–æ–º–∞–Ω–∞ Magic üÉè</h1></header>

<main>
  <section class="roulette-card">
    <!-- STRIP -->
    <div class="strip-wrap">
      <div class="pointerTop"></div>
      <div class="pointerBottom"></div>
      <div id="strip" class="strip"></div>
    </div>

    <!-- CONTROLS -->
    <div class="controls">
      <h2>üé∞ –¢–∞–π–Ω–∏–∫ ‚Äî VIP-—Ä—É–ª–µ—Ç–∫–∞</h2>

      <div class="stats">
        <span id="pill-sub" class="pill sub hidden">–ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞: 2 –∫—Ä—É—Ç–∫–∏/–¥–µ–Ω—å</span>
        <span class="pill">–î–æ—Å—Ç—É–ø–Ω–æ –∫—Ä—É—Ç–æ–∫: <b id="spinsLeft">0</b></span>
      </div>

      <button id="spinBtn" class="btn">–ö—Ä—É—Ç–∏—Ç—å</button>
      <button id="subscribeBtn" class="btn btn-secondary">–û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É ‚Äî 299 ‚ÇΩ/–º–µ—Å</button>

      <div id="resultBox" class="note hidden"><span class="result" id="resultText"></span></div>

      <div class="note">
        –†—É–ª–µ—Ç–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º –∏–∑ Telegram. –ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π ‚Äî +1 –∫—Ä—É—Ç–∫–∞, –∫–æ–≥–¥–∞ –¥—Ä—É–≥ —Å–¥–µ–ª–∞–µ—Ç —Å–≤–æ—é –ø–µ—Ä–≤—É—é –ø—Ä–æ–∫—Ä—É—Ç–∫—É.
      </div>

      <div class="note">
        –ó–∞–∫—Ä—ã—Ç—ã–π –∫–∞–Ω–∞–ª ¬´–¢–∞–π–Ω–∏–∫¬ª: —Å–µ–∫—Ä–µ—Ç–Ω—ã–µ –æ–±—É—á–∞–ª–∫–∏, —Ä–∞–∑–±–æ—Ä –≤–∞—à–∏—Ö –≤–∏–¥–µ–æ —Å —Ñ–æ–∫—É—Å–∞–º–∏, —á–µ–ª–ª–µ–Ω–¥–∂–∏, —Å–æ–≤–µ—Ç—ã –∏ –µ–∂–µ–º–µ—Å—è—á–Ω—ã–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∏ –ø—Ä–∏–∑–æ–≤.
      </div>
    </div>
  </section>
</main>

<script>
/* ========================== –ù–ê–°–¢–†–û–ô–ö–ò ========================== */
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycby2R4j1aBQ2zmybXyqjVhgFntoduCYYX6AuZ8kMmRUWdF8ZQCNTTpPij0kmxaSxAZmjvg/exec';
const PRODAMUS_PAY_URL_BASE = 'https://pay.your-prodamus.example/subscribe-299'; // –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à—É —Å—Å—ã–ª–∫—É

/* ======================= –¢–ï–õ–ï–ì–†–ê–ú / –ö–û–ù–¢–ï–ö–°–¢ ==================== */
function getTelegramId(){
  if (window.Telegram && Telegram.WebApp?.initDataUnsafe?.user){
    return String(Telegram.WebApp.initDataUnsafe.user.id);
  }
  const q = new URL(location.href).searchParams;
  const tg = q.get('tg_id');
  if (tg){ localStorage.setItem('magic_tg_id', tg); return tg; }
  return localStorage.getItem('magic_tg_id');
}
function getReferrerFromUrl(){
  const url = new URL(location.href);
  const ref = url.searchParams.get('ref');
  if (ref){ localStorage.setItem('magic_referrer', ref); }
  return localStorage.getItem('magic_referrer');
}

/* ========================= –ü–û–î–ü–ò–°–ö–ê ============================ */
function hasActiveSubscription(){ return localStorage.getItem('magic_sub_active')==='1'; }
function setSubscriptionActive(active){
  localStorage.setItem('magic_sub_active', active?'1':'0');
  document.getElementById('pill-sub').classList.toggle('hidden', !active);
}
(function postPay(){
  const url = new URL(location.href);
  if (url.searchParams.get('sub')==='1'){ setSubscriptionActive(true); }
})();

/* ========================= –õ–ò–ú–ò–¢–´ –ö–†–£–¢–û–ö ======================= */
function todayKey(){ const d=new Date(); return d.getFullYear()+'-'+(d.getMonth()+1)+'-'+d.getDate(); }
function getDailyLimit(){ return hasActiveSubscription()?2:1; }
function loadSpinState(){
  const key=todayKey();
  const data=JSON.parse(localStorage.getItem('magic_spin_state')||'{}');
  if (data.date!==key){ return {date:key, used:0, bonus:Number(localStorage.getItem('magic_bonus_pool')||'0')}; }
  return data;
}
function saveSpinState(st){
  localStorage.setItem('magic_spin_state', JSON.stringify(st));
  localStorage.setItem('magic_bonus_pool', String(st.bonus||0));
  updateSpinsUI();
}
function spinsLeft(){ const st=loadSpinState(); return Math.max(0, getDailyLimit()-st.used) + (st.bonus||0); }
function consumeSpin(){
  const st=loadSpinState();
  if (st.bonus>0) st.bonus--; else st.used = Math.min(getDailyLimit(), st.used+1);
  saveSpinState(st);
}
function updateSpinsUI(){
  document.getElementById('spinsLeft').textContent = spinsLeft();
  document.getElementById('spinBtn').disabled = (spinsLeft()<=0);
}

/* ========================= –ü–†–û–î–ê–ú–£–° ============================ */
document.getElementById('subscribeBtn').addEventListener('click', ()=>{
  const tg = getTelegramId();
  const url = new URL(PRODAMUS_PAY_URL_BASE);
  if (tg) url.searchParams.set('tg_id', tg);
  window.open(url.toString(), '_blank');
});

/* ========================= –ü–†–ò–ó–´ (–í–ï–°–ê) ======================== */
/* —Å—É–º–º–∞—Ä–Ω–æ 100% */
const prizes = [
  {key:'empty',     label:'–ü–æ–≤–µ–∑—ë—Ç –≤ –¥—Ä—É–≥–æ–π —Ä–∞–∑', emoji:'‚àÖ',    weight:57.98, color:'#1a2133'},
  {key:'off5',      label:'–°–∫–∏–¥–∫–∞ 5% –Ω–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ',  emoji:'‚Äì5%',  weight:25,   color:'#0f3b75'},
  {key:'off15',     label:'–°–∫–∏–¥–∫–∞ 15% –Ω–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ', emoji:'‚Äì15%', weight:10,   color:'#1a75c7'},
  {key:'off25',     label:'–°–∫–∏–¥–∫–∞ 25% –Ω–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ', emoji:'‚Äì25%', weight:5,    color:'#126b52'},
  {key:'headphones',label:'–ù–∞—É—à–Ω–∏–∫–∏',                 emoji:'üéß',   weight:1,    color:'#432a5f'},
  {key:'jbl',       label:'–ö–æ–ª–æ–Ω–∫–∞ JBL',              emoji:'üîä',   weight:1,    color:'#6e3a0f'},
  {key:'ps',        label:'PlayStation',              emoji:'üéÆ',   weight:0.01, color:'#5a0c0c'},
  {key:'iphone',    label:'iPhone',                   emoji:'üì±',   weight:0.01, color:'#7a1111'}
];

/* ====================== –°–ë–û–†–ö–ê –õ–ï–ù–¢–´ –ö–ê–†–¢–û–ß–ï–ö ================== */
const strip = document.getElementById('strip');
function createItem(p){
  const el=document.createElement('div');
  el.className='item';
  el.style.background=`linear-gradient(180deg, ${p.color}, #0b0f1b)`;
  el.innerHTML = `<div class="icon">${p.emoji}</div>
                  <div class="title">${p.label}</div>
                  <div class="tag">VIP</div>`;
  return el;
}
/* –¥–µ–ª–∞–µ–º –±–æ–ª—å—à—É—é –ª–µ–Ω—Ç—É: –ø–æ–≤—Ç–æ—Ä–∏–º –ø—Ä–∏–∑—ã –º–Ω–æ–≥–æ —Ä–∞–∑ */
const REPEAT = 30; // –¥–ª–∏–Ω–∞ –¥–æ—Ä–æ–∂–∫–∏
const sequence = [];
for(let r=0;r<REPEAT;r++){ prizes.forEach(p=>sequence.push(p)); }
sequence.forEach(p => strip.appendChild(createItem(p)));

let ITEM_W = 240 + 14; // —à–∏—Ä–∏–Ω–∞ + gap (–±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞)
setTimeout(()=>{ // –ø–æ—Å–ª–µ layout
  const first = strip.querySelector('.item');
  if (first){
    const style = getComputedStyle(first);
    ITEM_W = first.getBoundingClientRect().width + parseFloat(getComputedStyle(strip).columnGap||14) || 254;
  }
}, 50);

/* ==================== –í–´–ë–û–† –ü–û –í–ï–°–ê–ú + –ê–ù–ò–ú–ê–¶–ò–Ø ================ */
function pickPrize(){
  const r=Math.random()*100; let acc=0;
  for(const p of prizes){ acc+=p.weight; if (r<=acc) return p; }
  return prizes[0];
}

/* –ø—Ä–æ–∫—Ä—É—Ç–∫–∞: start –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ + blur, –∑–∞—Ç–µ–º –ø–ª–∞–≤–Ω–æ–µ –∑–∞–º–µ–¥–ª–µ–Ω–∏–µ */
let spinning=false, currentX=0; // –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ (–≤–ª–µ–≤–æ)
function spin(){
  if (spinning) return;
  if (spinsLeft()<=0){ showResult('–ö—Ä—É—Ç–æ–∫ –Ω–µ—Ç. –û—Ñ–æ—Ä–º–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É –∏–ª–∏ –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ –¥—Ä—É–≥–∞.', true); return; }

  const tg = getTelegramId();
  if (!tg){ showResult('–†—É–ª–µ—Ç–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ Telegram-–±–æ—Ç–∞.', true); return; }

  spinning = true;

  const chosen = pickPrize();

  // –Ω–∞–π–¥—ë–º –∏–Ω–¥–µ–∫—Å –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –≤ –±–ª–∏–∂–∞–π—à–µ–º ¬´—Ö–≤–æ—Å—Ç–µ¬ª, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –¥–ª–∏–Ω–Ω—ã–π –ø—Ä–æ–≥–æ–Ω
  const centerIndex = Math.round(Math.abs(currentX)/ITEM_W) + Math.floor(strip.clientWidth/(2*ITEM_W));
  let targetIndex = -1;
  for(let i=centerIndex+20; i<sequence.length-10; i++){ // –≤–ø–µ—Ä–µ–¥–∏ 20+ –∫–∞—Ä—Ç–æ—á–µ–∫
    if (sequence[i].key === chosen.key){ targetIndex = i; break; }
  }
  if (targetIndex<0){ targetIndex = centerIndex + 30; } // —Ñ–æ–ª–±–µ–∫

  const viewportCenter = strip.clientWidth/2;
  const targetX = -(targetIndex*ITEM_W - viewportCenter + (ITEM_W/2));

  const duration = 5200; // –º—Å
  const start = performance.now();
  const startX = currentX;

  // easing out
  const easeOutCubic = t => 1 - Math.pow(1 - t, 3);

  function frame(now){
    const t = Math.min(1, (now-start)/duration);
    const eased = easeOutCubic(t);

    // –ø–æ–∑–∏—Ü–∏—è
    currentX = startX + (targetX - startX)*eased;
    strip.style.transform = `translate3d(${currentX}px,0,0)`;

    // ¬´—Å–∫–æ—Ä–æ—Å—Ç—å¬ª ~ –ø—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è easing -> blur (—Å–Ω–∞—á–∞–ª–∞ —Å–∏–ª—å–Ω—ã–π, –ø–æ—Ç–æ–º —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è)
    const speed = 1 - t; // –≥—Ä—É–±–æ
    const blur = 12*speed*speed + (t<0.15 ? 8 : 0); // —Å—Ç–∞—Ä—Ç–æ–≤—ã–π ¬´—Å—É–ø–µ—Ä-—Ä–∞–∑–º—ã—Ç—ã–π¬ª
    strip.style.filter = `blur(${blur.toFixed(2)}px)`;

    if (t<1){ requestAnimationFrame(frame); }
    else{
      strip.style.filter = 'blur(0px)';
      spinning=false;
      onSpinFinished(chosen);
    }
  }
  requestAnimationFrame(frame);
}

/* ========================= –ò–¢–û–ì –°–ü–ò–ù–ê ========================== */
document.getElementById('spinBtn').addEventListener('click', spin);

function showResult(text, warn=false){
  const box = document.getElementById('resultBox');
  const t = document.getElementById('resultText');
  t.textContent = text;
  box.classList.remove('hidden');
  box.style.borderColor = warn ? '#5d1b1b' : '#2b3a67';
  box.style.background = warn ? '#2a1010' : '#0e1529';
}

async function onSpinFinished(prize){
  consumeSpin();
  updateSpinsUI();

  const msg = (prize.key==='empty') ? '–°–µ–≥–æ–¥–Ω—è –±–µ–∑ –ø—Ä–∏–∑–∞ ‚Äî –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–≤—Ç—Ä–∞!' : `–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏: ${prize.emoji} ${prize.label}`;
  showResult(msg);

  const tg = getTelegramId();
  const referrer = localStorage.getItem('magic_referrer');
  // –ª–æ–≥ —Å–ø–∏–Ω–∞
  fetch(WEB_APP_URL, {
    method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({action:'spin', tg_id: tg||'unknown', prize_key: prize.key, prize_label: prize.label, ts:new Date().toISOString(), referrer: referrer||null})
  }).catch(()=>{});

  // –∫—Ä–µ–¥–∏—Ç —Ä–µ—Ñ–µ—Ä–∞–ª—É –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–µ —ç—Ç–æ–≥–æ —é–∑–µ—Ä–∞
  if (!localStorage.getItem('magic_first_spin_done')){
    localStorage.setItem('magic_first_spin_done','1');
    if (referrer){
      fetch(WEB_APP_URL, {
        method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({action:'credit_ref', referrer, by: tg||'unknown', ts:new Date().toISOString()})
      }).catch(()=>{});
    }
  }
}

/* ========================= –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ======================= */
(function init(){
  const tg=getTelegramId(); if (tg) localStorage.setItem('magic_tg_id', tg);
  getReferrerFromUrl();
  setSubscriptionActive(hasActiveSubscription());
  updateSpinsUI();

  // –µ—Å–ª–∏ –Ω–µ—Ç tg ‚Äî –∑–∞–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É, –Ω–æ –ø–æ–∫–∞–∂–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ
  if (!tg){
    document.getElementById('spinBtn').disabled = true;
    showResult('–û—Ç–∫—Ä–æ–π—Ç–µ —Ä—É–ª–µ—Ç–∫—É —á–µ—Ä–µ–∑ Telegram-–±–æ—Ç–∞, —á—Ç–æ–±—ã —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å.', true);
  }
})();
</script>
</body>
</html>
